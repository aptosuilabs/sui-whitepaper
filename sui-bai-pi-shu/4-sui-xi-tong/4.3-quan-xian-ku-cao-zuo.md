# 4.3 权限库操作

处理事务。收到交易 Tx 后，授权机构会执行多项检查：

(1) 确保 epoch(Tx) 是当前 epoch。

(2) 它确保所有对象引用输入(Tx) 和支付(Tx) 中的气体对象引用存在于Obj𝑣 中，并将它们加载到\[Obj] 中。对于拥有的对象，应该有确切的参考；对于只读或共享对象，对象 ID 应该存在。

(3) 确保可以在气体对象中提供足够的气体来支付执行交易的成本。

(4) 检查valid(Tx, \[Obj]) 是否为真。此步骤确保事务中的身份验证信息允许访问拥有的对象。

(5) 它检查所有拥有的输入（Tx）对象的 Lock𝑣 \[ObjRef] 是否存在，它要么是 None 要么设置为相同的 Tx，并自动将其设置为 TxSign。 （我们称这些为“锁检查”）。

如果任何检查失败，则处理结束，并返回错误。但是，Lock𝑣 的部分更新持续存在是安全的（尽管我们当前的实现不做部分更新，而是对所有锁进行原子更新）。

如果所有检查都成功，则当局返回交易签名，即。部分证书 TxSign。成功处理订单是幂等的，并返回部分证书 (TxSign) 或完整证书 (TxCert)（如果可用）。

任何一方都可以为一组权限核对交易和签名（TxSign），形成一个纪元𝑒的法定人数，以形成交易证书 TxCert。

工艺证书。收到证书后，权威机构会检查交易的所有有效性条件，除了与锁相关的条件（所谓的“锁检查”）。相反，它执行以下检查：对于输入（Tx）中的每个拥有的输入对象，它检查锁是否存在，并且它是无，设置为任何 TxSign，或设置为与当前证书相同的交易的证书。如果此修改锁检查失败，则该权限已检测到不可恢复的拜占庭故障，停止正常操作，并启动灾难恢复过程。对于共享对象（参见第 4.4 节），当局检查锁定是否已通过在共识中排序的证书设置，以确定要使用的共享对象的版本。如果是这样，交易可能会被执行；否则需要先等待这样的排序。

如果检查成功，则授权将证书添加到其证书映射中，连同其执行产生的效果，即。 Ct𝑣 \[TxDigest] → (TxCert, EffSign);它更新锁映射以记录证书 Lock𝑣 \[ObjRef] → TxCert 用于所有拥有的未设置为证书的锁的输入对象。一旦 Input(Tx) 中的所有对象都插入到 Obj𝑣 中，那么 EffSign 中的所有效果也会通过将它们的 ObjRef 和内容添加到 Obj𝑣 来实现。最后，对于在 EffSign 中创建或变异的所有内容，同步映射会更新以将它们映射到 Tx。

评论。处理交易和证书的逻辑导致了许多重要的属性：

• 因果关系和平行性。交易和证书的处理条件确保因果执行：如果授权机构已经处理了创建交易所依赖的对象的所有证书（包括拥有的、共享的和只读的），那么它只会通过签署交易来“投票”。类似地，只有当它所依赖的所有输入对象都存在于它的本地对象映射中时，一个权威才会处理一个证书。这强加了因果执行顺序，但也使不存在因果关系的事务能够在不同的内核或机器上并行执行。

• 签名一次，安全。 Lock𝑣 \[·] 中所有拥有的输入对象锁被设置为第一个通过使用它们的检查的交易 Tx，然后是第一个使用它们的证书对象作为输入。我们称之为将对象锁定到该事务，并且在一个时期内没有解锁。因此，一个权限只为每个锁签署一个事务，这是一致广播 \[6] 的重要组成部分，因此也是 Sui 的安全性。

• 灾难恢复。一个权威机构检测到同一个锁的两个相互矛盾的证书，就有了不可恢复的拜占庭行为的证据——即证明法定人数诚实权威假设不成立。这两个相互矛盾的证书是欺诈证明 \[1]，可以与所有权限和副本共享以触发灾难恢复过程。当局还可以获得其他形式的不可恢复的拜占庭行为证明，例如 >1/3 的签名效果 (EffSign)，表示证书执行不正确。或者带有不代表先前处理的证书的正确输出的输入对象的证书。这些也可以打包为欺诈证明，并与所有权威机构和副本共享。请注意，这些与证明少数权威（≤ 1/3 的权益）或对象所有者（任意数量）是拜占庭式或模棱两可的证明不同，这可以在不中断服务的情况下被容忍。

• 确定性。当局为 Lock𝑣、Ct𝑣 和 Obj𝑣、Sync𝑣 中的索引的任何读取请求返回证书 (TxCert) 和签名效果 (EffSign)。如果超过法定人数的授权报告 Tx 包含在其 Ct𝑣 存储中，则交易被视为最终交易。这意味着效果证书 (EffCert) 是可转让的确定性证明。但是，使用对象的证书也证明其因果路径中的所有依赖证书也是最终的。向任何一方提供证书，然后该方可以将其提交给绝大多数权威机构进行处理，这也确保了证书效果的最终确定性。请注意，finality 晚于 fastpay \[3] 以确保重新配置下的安全性。但是，权威机构可以在看到证书时应用事务的效果，而不是等待提交。
